libkj = declare_dependency(
  include_directories: 'capnp/c++/src',
  link_with: shared_library('kj',
    'capnp/c++/src/kj/array.c++',
    'capnp/c++/src/kj/cidr.c++',
    'capnp/c++/src/kj/list.c++',
    'capnp/c++/src/kj/common.c++',
    'capnp/c++/src/kj/debug.c++',
    'capnp/c++/src/kj/exception.c++',
    'capnp/c++/src/kj/io.c++',
    'capnp/c++/src/kj/memory.c++',
    'capnp/c++/src/kj/mutex.c++',
    'capnp/c++/src/kj/string.c++',
    'capnp/c++/src/kj/source-location.c++',
    'capnp/c++/src/kj/hash.c++',
    'capnp/c++/src/kj/table.c++',
    'capnp/c++/src/kj/thread.c++',
    'capnp/c++/src/kj/main.c++',
    'capnp/c++/src/kj/arena.c++',
    'capnp/c++/src/kj/test-helpers.c++',
    'capnp/c++/src/kj/units.c++',
    'capnp/c++/src/kj/encoding.c++',
    'capnp/c++/src/kj/refcount.c++',
    'capnp/c++/src/kj/string-tree.c++',
    'capnp/c++/src/kj/time.c++',
    'capnp/c++/src/kj/filesystem.c++',
    'capnp/c++/src/kj/filesystem-disk-unix.c++',
    'capnp/c++/src/kj/filesystem-disk-win32.c++',
    'capnp/c++/src/kj/parse/char.c++',
    include_directories: 'capnp/c++/src',
    install: true,
    install_rpath: origin_rpath,
  ),
)

install_headers(
  'capnp/c++/src/kj/cidr.h',
  'capnp/c++/src/kj/common.h',
  'capnp/c++/src/kj/units.h',
  'capnp/c++/src/kj/memory.h',
  'capnp/c++/src/kj/refcount.h',
  'capnp/c++/src/kj/array.h',
  'capnp/c++/src/kj/list.h',
  'capnp/c++/src/kj/vector.h',
  'capnp/c++/src/kj/string.h',
  'capnp/c++/src/kj/string-tree.h',
  'capnp/c++/src/kj/source-location.h',
  'capnp/c++/src/kj/hash.h',
  'capnp/c++/src/kj/table.h',
  'capnp/c++/src/kj/map.h',
  'capnp/c++/src/kj/encoding.h',
  'capnp/c++/src/kj/exception.h',
  'capnp/c++/src/kj/debug.h',
  'capnp/c++/src/kj/arena.h',
  'capnp/c++/src/kj/io.h',
  'capnp/c++/src/kj/tuple.h',
  'capnp/c++/src/kj/one-of.h',
  'capnp/c++/src/kj/function.h',
  'capnp/c++/src/kj/mutex.h',
  'capnp/c++/src/kj/thread.h',
  'capnp/c++/src/kj/threadlocal.h',
  'capnp/c++/src/kj/filesystem.h',
  'capnp/c++/src/kj/time.h',
  'capnp/c++/src/kj/main.h',
  'capnp/c++/src/kj/win32-api-version.h',
  'capnp/c++/src/kj/windows-sanity.h',
  subdir: 'kj',
)

libcapnp = declare_dependency(
  include_directories: 'capnp/c++/src',
  link_with: shared_library('capnp',
    'capnp/c++/src/capnp/c++.capnp.c++',
    'capnp/c++/src/capnp/blob.c++',
    'capnp/c++/src/capnp/arena.c++',
    'capnp/c++/src/capnp/layout.c++',
    'capnp/c++/src/capnp/list.c++',
    'capnp/c++/src/capnp/any.c++',
    'capnp/c++/src/capnp/message.c++',
    'capnp/c++/src/capnp/schema.capnp.c++',
    'capnp/c++/src/capnp/stream.capnp.c++',
    'capnp/c++/src/capnp/serialize.c++',
    'capnp/c++/src/capnp/serialize-packed.c++',
    'capnp/c++/src/capnp/schema.c++',
    'capnp/c++/src/capnp/schema-loader.c++',
    'capnp/c++/src/capnp/dynamic.c++',
    'capnp/c++/src/capnp/stringify.c++',
    include_directories: 'capnp/c++/src',
    dependencies: libkj,
    install: true,
    install_rpath: origin_rpath,
  ),
)

install_headers(
  'capnp/c++/src/capnp/c++.capnp',
  'capnp/c++/src/capnp/c++.capnp.h',
  'capnp/c++/src/capnp/common.h',
  'capnp/c++/src/capnp/blob.h',
  'capnp/c++/src/capnp/endian.h',
  'capnp/c++/src/capnp/layout.h',
  'capnp/c++/src/capnp/orphan.h',
  'capnp/c++/src/capnp/list.h',
  'capnp/c++/src/capnp/any.h',
  'capnp/c++/src/capnp/message.h',
  'capnp/c++/src/capnp/capability.h',
  'capnp/c++/src/capnp/membrane.h',
  'capnp/c++/src/capnp/dynamic.h',
  'capnp/c++/src/capnp/schema.h',
  'capnp/c++/src/capnp/schema.capnp.h',
  'capnp/c++/src/capnp/stream.capnp.h',
  'capnp/c++/src/capnp/schema-lite.h',
  'capnp/c++/src/capnp/schema-loader.h',
  'capnp/c++/src/capnp/schema-parser.h',
  'capnp/c++/src/capnp/pretty-print.h',
  'capnp/c++/src/capnp/serialize.h',
  'capnp/c++/src/capnp/serialize-async.h',
  'capnp/c++/src/capnp/serialize-packed.h',
  'capnp/c++/src/capnp/serialize-text.h',
  'capnp/c++/src/capnp/pointer-helpers.h',
  'capnp/c++/src/capnp/generated-header-support.h',
  'capnp/c++/src/capnp/raw-schema.h',
  subdir: 'capnp',
)

libcapnp_json = declare_dependency(
  include_directories: 'capnp/c++/src',
  link_with: shared_library('capnp-json',
    'capnp/c++/src/capnp/compat/json.c++',
    'capnp/c++/src/capnp/compat/json.capnp.c++',
    dependencies: [libkj, libcapnp],
    install: true,
    install_rpath: origin_rpath,
  ),
)

libcapnpc = declare_dependency(
  include_directories: 'capnp/c++/src',
  link_with: shared_library('capnpc',
    'capnp/c++/src/capnp/compiler/type-id.c++',
    'capnp/c++/src/capnp/compiler/error-reporter.c++',
    'capnp/c++/src/capnp/compiler/lexer.capnp.c++',
    'capnp/c++/src/capnp/compiler/lexer.c++',
    'capnp/c++/src/capnp/compiler/grammar.capnp.c++',
    'capnp/c++/src/capnp/compiler/parser.c++',
    'capnp/c++/src/capnp/compiler/generics.c++',
    'capnp/c++/src/capnp/compiler/node-translator.c++',
    'capnp/c++/src/capnp/compiler/compiler.c++',
    'capnp/c++/src/capnp/schema-parser.c++',
    'capnp/c++/src/capnp/serialize-text.c++',
    include_directories: 'capnp/c++/src',
    dependencies: [libkj, libcapnp],
    install: true,
    install_rpath: origin_rpath,
  ),
)

capnp_prog = executable(
  'capnp',
  'capnp/c++/src/capnp/compiler/module-loader.c++',
  'capnp/c++/src/capnp/compiler/capnp.c++',
  dependencies: [libcapnpc, libcapnp_json, libcapnp, libkj],
  install: true,
  install_rpath: origin_rpath,
)

capnpc_cpp_prog = executable(
  'capnpc-c++',
  'capnp/c++/src/capnp/compiler/capnpc-c++.c++',
  dependencies: [libkj, libcapnpc, libcapnp],
  install: true,
  install_rpath: origin_rpath,
)

capnp_include_path = meson.current_source_dir() + '/capnp/c++/src'
